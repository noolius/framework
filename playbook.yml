---
  - name: Provisioning Alpine 3.15 K8s (control-planes)
    hosts: control_planes
    become: true
    vars:
      linkerd_version: edge-21.12.3
      cilium_cli_version: v0.10.0
      hubble_version: v0.9.0
      cosign_version: v1.3.1
      helm_version: v3.7.2
      kapp_version: v0.43.0
      crank_version: v1.5.1
      thanos_cli_version: 0.23.2-rc.0
      kustomize_version: v4.4.1
      cf_version: 7.4.0
      certmanager_version: v1.6.1
    tasks:
      - name: Downloading cosign
        get_url:
          url: https://github.com/sigstore/cosign/releases/download/{{ cosign_version | quote }}/cosign-linux-amd64
          dest: /usr/local/bin/cosign
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:1227b270e5d7d21d09469253cce17b72a14f6b7c9036dfc09698c853b31e8fc8
      - name: Downloading Helm cli
        get_url:
          url: https://get.helm.sh/helm-{{ helm_version | quote }}-linux-amd64.tar.gz
          dest: /root/helm-{{ helm_version | quote }}-linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:4ae30e48966aba5f807a4e140dad6736ee1a392940101e4d79ffb4ee86200a9e
      - name: Extracting Helm cli
        unarchive:
          src: /root/helm-{{ helm_version | quote }}-linux-amd64.tar.gz
          dest: /root
          mode: '0400'
          remote_src: true
          extra_opts:
          - linux-amd64/helm
      - name: Installing Helm cli
        copy:
          src: /root/linux-amd64/helm
          dest: /usr/local/bin/helm
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading and installing kapp cli
        get_url:
          url: https://github.com/vmware-tanzu/carvel-kapp/releases/download/{{ kapp_version | quote }}/kapp-linux-amd64
          dest: /usr/local/bin/kapp
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:f8669039dfba001081c94576c898d10aba28ecceffcd98708e8f2c87c13109e4
      - name: Downloading and installing Linkerd2 cli
        get_url:
          url: https://github.com/linkerd/linkerd2/releases/download/{{ linkerd_version | quote }}/linkerd2-cli-{{ linkerd_version | quote }}-linux-amd64
          dest: /usr/local/bin/linkerd
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:65edb675dda4a6863368e626701e7512a97a96a34b421ec070027b6ab5647172
      - name: Downloading and installing Crossplane cli
        get_url:
          url: https://releases.crossplane.io/stable/{{ crank_version | quote }}/bin/linux_amd64/crank
          dest: /usr/local/bin/kubectl-crossplane
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:8117370ef35e24dcfa6a4030b041800db862a28a4924cda9cde9b095b7c62b13
      - name: Downloading Cilium cli
        get_url:
          url: https://github.com/cilium/cilium-cli/releases/download/{{ cilium_cli_version | quote }}/cilium-linux-amd64.tar.gz
          dest: /root/cilium-linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:2a309542dc9504d3ee3583617fef98e5cb24cdb5e8578a52fa6584932bb2c46c
      - name: Installing Cilium cli
        unarchive:
          src: /root/cilium-linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading Hubble cli
        get_url:
          url: https://github.com/cilium/hubble/releases/download/{{ hubble_version | quote }}/hubble-linux-amd64.tar.gz
          dest: /root/hubble-linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:63d62f6ea4b2daedaa08f95fbb95e457b4ee5d00167f4a84af0ba7ca3225924d
      - name: Installing Hubble cli
        unarchive:
          src: /root/hubble-linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading Thanos cli
        get_url:
          url: https://github.com/thanos-io/thanos/releases/download/v{{ thanos_cli_version |
            quote }}/thanos-{{ thanos_cli_version | quote }}.linux-amd64.tar.gz
          dest: /root/thanos-{{ thanos_cli_version | quote }}.linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:17b3f65de7f6c019e9459bf7079df274072da0487f97167ccaa43dab2f37cb41
      - name: Extracting Thanos cli
        unarchive:
          src: /root/thanos-{{ thanos_cli_version | quote }}.linux-amd64.tar.gz
          dest: /root
          mode: '0400'
          remote_src: true
          extra_opts:
          - thanos-{{ thanos_cli_version | quote }}.linux-amd64/thanos
      - name: Installing Thanos cli
        copy:
          src: /root/thanos-{{ thanos_cli_version | quote }}.linux-amd64/thanos
          dest: /usr/local/bin/thanos
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading cf v7 cli
        get_url:
          url: https://packages.cloudfoundry.org/stable?release=linux64-binary&version={{ cf_version | quote }}&source=github-rel
          dest: /root/cf7-cli_{{ cf_version | quote }}_linux_x86-64.tgz
          mode: '0400'
          checksum: sha256:6ac44598c580fe24c98f3b52df2e6357116478c68dee5c74800cb39cba421695
      - name: Installing cf v7 cli
        unarchive:
          src: /root/cf7-cli_{{ cf_version | quote }}_linux_x86-64.tgz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          extra_opts:
          - cf7
        register: installing_cf_v7_cli
      - name: Symlinking cf v7 cli
        file:
          src: /usr/local/bin/cf7
          dest: /usr/local/bin/cf
          owner: root
          group: root
          state: link
        when: installing_cf_v7_cli is succeeded
      - name: Downloading kubectl cert-manager
        get_url:
          url: https://github.com/jetstack/cert-manager/releases/download/{{ certmanager_version | quote }}/kubectl-cert_manager-linux-amd64.tar.gz
          dest: /root/kubectl-cert_manager-linux-amd64.tar.gz
          owner: root
          group: root
          mode: '0400'
          checksum: sha256:cf9cb0b1020cc437d431805be4baf2bc9de6de0b06e7821b0dd7d5d598cc1f36
      - name: Installing kubectl cert-manager
        unarchive:
          src: /root/kubectl-cert_manager-linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          extra_opts:
          - kubectl-cert_manager
      - name: Downloading Kustomize
        get_url:
          url: https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F{{ kustomize_version |
            quote }}/kustomize_{{ kustomize_version | quote }}_linux_amd64.tar.gz
          dest: /root/kustomize_{{ kustomize_version | quote }}_linux_amd64.tar.gz
          owner: root
          group: root
          mode: '0400'
          checksum: sha256:2d5927efec40ba32a121c49f6df9955b8b8a296ef1dec4515a46fc84df158798
      - name: Installing Kustomize
        unarchive:
          src: /root/kustomize_{{ kustomize_version | quote }}_linux_amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          extra_opts:
          - kustomize
  - name: Provisioning Alpine 3.15 K8s (all)
    hosts: "*"
    become: true
    vars:
      doas_d_conf: |
        permit nopass keepenv setenv { PATH } root as root
        permit nopass keepenv setenv { PATH } vagrant as root
      more_modules: |
        overlay
        br_netfilter
        wireguard
      sysctl_tunables: |
        net.ipv4.ip_forward = 1
        net.bridge.bridge-nf-call-iptables = 1
        net.bridge.bridge-nf-call-ip6tables = 1
        net.netfilter.nf_conntrack_max = 1000000
      repo_contents: |
        https://dl-3.alpinelinux.org/alpine/edge/main
        https://dl-3.alpinelinux.org/alpine/edge/community
        https://dl-3.alpinelinux.org/alpine/edge/testing
      mount_rshared_openrc: |
        #!/sbin/openrc-run
        name="mount_rshared"
        command="/bin/mount"
        command_args="--make-rshared /"
        depend() {
          before kubelet
        }
    tasks:
      - name: Configuring /e/doas.conf
        copy:
          content: "{{ doas_d_conf }}"
          dest: /etc/doas.conf
          owner: root
          group: root
          mode: '0600'
          backup: true
      - name: Configuring additional kernel modules to load
        copy:
          content: "{{ more_modules }}"
          dest: /etc/modules-load.d/K8s.conf
          mode: '0440'
      - name: Configuring sysctl tunables
        copy:
          content: "{{ sysctl_tunables }}"
          dest: /etc/sysctl.d/K8s_v2.conf
          mode: '0440'
      - name: Replacing /e/apk/repositories with edge/*
        copy:
          content: "{{ repo_contents }}"
          dest: /etc/apk/repositories
          owner: root
          group: root
          mode: '0444'
          backup: true
      - name: Upgrading distro packages to their latest versions
        community.general.apk:
          update_cache: true
          upgrade: true
        register: upgrading
        failed_when: "'timed out' in upgrading.stderr"
      - name: Re-attempting packages upgrade
        community.general.apk:
          upgrade: true
        when: upgrading is not succeeded
      - name: Adding cluster packages
        community.general.apk:
          name:
            - wireguard-tools
            - salt-minion
            - containerd
            - containerd-openrc
            - cni-plugins
            - conntrack-tools
            - socat
            - jq
            - kubelet
            - kubelet-openrc
            - kubeadm
            - cri-tools
            - doas
          state: latest
      - name: Checking whether to configure salt-minion
        ansible.builtin.stat:
          path: /vagrant/no_salt
        register: test_contents
      - name: Getting fingerprint of salt server
        ansible.builtin.command: cat /vagrant/pub_fingerprint
        register: fingerprint
        when: not test_contents.stat.exists
      - name: Creating /e/salt/minion.d
        file:
          path: /etc/salt/minion.d
          state: directory
          owner: root
          group: root
          mode: '0755'
        when: not test_contents.stat.exists
      - name: Seeding salt-master IPv4
        copy:
          content: "master: '{{ ansible_default_ipv4.gateway }}'"
          dest: /etc/salt/minion.d/master.conf
          owner: root
          group: root
          mode: '0444'
        when: not test_contents.stat.exists
      - name: Seeding salt-master public key fingerprint
        copy:
          content: "master_finger: '{{ fingerprint.stdout }}'"
          dest: /etc/salt/minion.d/master_finger.conf
          owner: root
          group: root
          mode: '0444'
        when: not test_contents.stat.exists
      - name: Creating OpenRC script to mount --make-rshared /
        copy:
          content: "{{ mount_rshared_openrc }}"
          dest: /etc/init.d/mount_rshared
          owner: root
          group: root
          mode: '0550'
      - name: Enabling salt-minion service
        service:
          name: salt-minion
          enabled: true
        when: not test_contents.stat.exists
      - name: Enabling kubelet service
        service:
          name: kubelet
          enabled: true
      - name: Enabling containerd service
        service:
          name: containerd
          enabled: true
      - name: Enabling service to mount --make-rshared /
        service:
          name: mount_rshared
          enabled: true
  - name: Provisioning Alpine 3.15 K8s (control-planes...more)
    hosts: control_planes
    become: true
    tasks:
      - name: Adding cluster packages specific to control-planes
        community.general.apk:
          name:
            - etcd
            - etcd-openrc
            - etcd-ctl
            - kubectl
            - patch
            - yq
            - librdkafka
            - yajl
            - coreutils
          state: latest
      - name: Checking whether to copy kcat
        ansible.builtin.stat:
          path: /vagrant/kcat
        register: test_kcat
      - name: Copying kcat
        copy:
          src: /vagrant/kcat
          dest: /usr/local/bin/kcat
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          checksum: 7640e8c2b3d681edc04f8ad6384e822d877c89ed
        when: test_kcat.stat.exists
      - name: Checking whether to copy stern
        ansible.builtin.stat:
          path: /vagrant/stern
        register: test_stern
      - name: Copying stern
        copy:
          src: /vagrant/stern
          dest: /usr/local/bin/stern
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          checksum: a776b5c4d8fa9d253e1f911d86eb1ca78934ff16
        when: test_stern.stat.exists
      - name: Checking whether to copy kubectx
        ansible.builtin.stat:
          path: /vagrant/kubectx
        register: test_kubectx
      - name: Copying kubectx
        copy:
          src: /vagrant/kubectx
          dest: /usr/local/bin/kubectx
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          checksum: 943c0d47b5bd45fe0f8ea6b43dada537f87acbd6
        when: test_kubectx.stat.exists
      - name: Checking whether to copy kubens
        ansible.builtin.stat:
          path: /vagrant/kubens
        register: test_kubens
      - name: Copying kubens
        copy:
          src: /vagrant/kubens
          dest: /usr/local/bin/kubens
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          checksum: 8244d59345c9f78572db4a86b628a9cab13ebc92
        when: test_kubens.stat.exists
