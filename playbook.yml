---
  - name: Provisioning Alpine 3.14 K8s (control-planes)
    hosts: control_planes
    become: true
    tasks:
      - name: Downloading Helm cli
        get_url:
          url: https://get.helm.sh/helm-v3.7.0-linux-amd64.tar.gz
          dest: /root/helm-v3.7.0-linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:096e30f54c3ccdabe30a8093f8e128dba76bb67af697b85db6ed0453a2701bf9
      - name: Extracting Helm cli
        unarchive:
          src: /root/helm-v3.7.0-linux-amd64.tar.gz
          dest: /root
          mode: '0400'
          remote_src: true
          extra_opts:
          - linux-amd64/helm
      - name: Installing Helm cli
        copy:
          src: /root/linux-amd64/helm
          dest: /usr/local/bin/helm
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading and installing kapp cli
        get_url:
          url: https://github.com/vmware-tanzu/carvel-kapp/releases/download/v0.37.0/kapp-linux-amd64
          dest: /usr/local/bin/kapp
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:f845233deb6c87feac7c82d9b3f5e03ced9a4672abb1a14d4e5b74fe53bc4538
      - name: Downloading and installing Linkerd2 edge cli
        get_url:
          url: https://github.com/linkerd/linkerd2/releases/download/edge-21.9.3/linkerd2-cli-edge-21.9.3-linux-amd64
          dest: /usr/local/bin/linkerd
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:f9c29301255d2088af4f857f4bc7c89b1b1b7511174321e3db08fd47091d6de2
      - name: Downloading and installing Crossplane cli
        get_url:
          url: https://releases.crossplane.io/stable/current/bin/linux_amd64/crank
          dest: /usr/local/bin/kubectl-crossplane
          owner: root
          group: root
          mode: '0555'
          checksum: sha256:7b32875044fdc5fcfbdf6a8d7525e932d1fae1a4c99acdfbfb2fb9856a611524
      - name: Downloading Cilium cli
        get_url:
          url: https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
          dest: /root/cilium-linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:fafd695f029f4406304eb0c951d21cc3074f3c1e53fbc198fe521ee16797c095
      - name: Installing Cilium cli
        unarchive:
          src: /root/cilium-linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading Hubble cli
        get_url:
          url: https://github.com/cilium/hubble/releases/latest/download/hubble-linux-amd64.tar.gz
          dest: /root/hubble-linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:e45c85b34d022b17ddb48621583c52b6d86e2e47e6fe71691ee46ff9f89edc27
      - name: Installing Hubble cli
        unarchive:
          src: /root/hubble-linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading Thanos cli
        get_url:
          url: https://github.com/thanos-io/thanos/releases/download/v0.22.0/thanos-0.22.0.linux-amd64.tar.gz
          dest: /root/thanos-0.22.0.linux-amd64.tar.gz
          mode: '0400'
          checksum: sha256:0b930bbd7636aa9377b0ba8e8f01bd7affd79162abe798b2ed042b26d7b46df8
      - name: Installing Thanos cli
        unarchive:
          src: /root/thanos-0.22.0.linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
      - name: Downloading cf v7 cli
        get_url:
          url: https://s3-us-west-1.amazonaws.com/v7-cf-cli-releases/releases/v7.3.0/cf7-cli_7.3.0_linux_x86-64.tgz
          dest: /root/cf7-cli_7.3.0_linux_x86-64.tgz
          mode: '0400'
          checksum: sha256:7a78614b2bb58e633d9488a357871c3ce2cc1b70b08f3e56d2bb9c82505565f9
      - name: Installing cf v7 cli
        unarchive:
          src: /root/cf7-cli_7.3.0_linux_x86-64.tgz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          extra_opts:
          - cf7
          - cf
      - name: Downloading kubectl cert-manager
        get_url:
          url: https://github.com/jetstack/cert-manager/releases/download/v1.5.3/kubectl-cert_manager-linux-amd64.tar.gz
          dest: /root/kubectl-cert_manager-linux-amd64.tar.gz
          owner: root
          group: root
          mode: '0400'
          checksum: sha256:58fb65e5b38e63c664b9219a5b1f555727cde2bc7e7f495cfe00ecb078da4b44
      - name: Installing kubectl cert-manager
        unarchive:
          src: /root/kubectl-cert_manager-linux-amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          extra_opts:
          - kubectl-cert_manager
      - name: Downloading Kustomize
        get_url:
          url: https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv4.3.0/kustomize_v4.3.0_linux_amd64.tar.gz
          dest: /root/kustomize_v4.3.0_linux_amd64.tar.gz
          owner: root
          group: root
          mode: '0400'
          checksum: sha256:d34818d2b5d52c2688bce0e10f7965aea1a362611c4f1ddafd95c4d90cb63319
      - name: Installing Kustomize
        unarchive:
          src: /root/kustomize_v4.3.0_linux_amd64.tar.gz
          dest: /usr/local/bin
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          extra_opts:
          - kustomize
  - name: Provisioning Alpine 3.14 K8s (all)
    hosts: "*"
    become: true
    vars:
      more_modules: |
        overlay
        br_netfilter
        wireguard
      sysctl_tunables: |
        net.ipv4.ip_forward = 1
        net.bridge.bridge-nf-call-iptables = 1
        net.bridge.bridge-nf-call-ip6tables = 1
        net.netfilter.nf_conntrack_max = 1000000
      repo_contents: |
        https://dl-3.alpinelinux.org/alpine/edge/main
        https://dl-3.alpinelinux.org/alpine/edge/community
        https://dl-3.alpinelinux.org/alpine/edge/testing
      mount_rshared_openrc: |
        #!/sbin/openrc-run
        name="mount_rshared"
        command="/bin/mount"
        command_args="--make-rshared /"
        depend() {
          before kubelet
        }
    tasks:
      - name: Configuring additional kernel modules to load
        copy:
          content: "{{ more_modules }}"
          dest: /etc/modules-load.d/K8s.conf
          mode: '0444'
      - name: Configuring sysctl tunables
        copy:
          content: "{{ sysctl_tunables }}"
          dest: /etc/sysctl.d/K8s_v2.conf
          mode: '0444'
      - name: Replacing /e/apk/repositories with edge/*
        copy:
          content: "{{ repo_contents }}"
          dest: /etc/apk/repositories
          owner: root
          group: root
          mode: '0444'
          backup: true
      - name: Upgrading distro packages to their latest versions
        community.general.apk:
          update_cache: true
          upgrade: true
        register: upgrading
        failed_when: "'timed out' in upgrading.stderr"
      - name: Re-attempting packages upgrade
        community.general.apk:
          upgrade: true
        when: upgrading is not succeeded
      - name: Adding cluster packages
        community.general.apk:
          name:
            - wireguard-tools
            - salt-minion
            - containerd
            - containerd-openrc
            - cni-plugins
            - conntrack-tools
            - socat
            - jq
            - kubelet
            - kubeadm
            - cri-tools
          state: latest
      - name: Checking whether to configure salt-minion
        ansible.builtin.stat:
          path: /vagrant/no_salt
        register: test_contents
      - name: Getting fingerprint of salt server
        ansible.builtin.command: cat pub_fingerprint
        register: fingerprint
        when: not test_contents.stat.exists
      - name: Creating /e/salt/minion.d
        file:
          path: /etc/salt/minion.d
          state: directory
          owner: root
          group: salt
          mode: '0750'
        when: not test_contents.stat.exists
      - name: Seeding salt-master IPv4
        copy:
          content: "master: '{{ ansible_default_ipv4.gateway }}'"
          dest: /etc/salt/minion.d/master.conf
          owner: root
          group: salt
          mode: '0440'
        when: not test_contents.stat.exists
      - name: Seeding salt-master key
        copy:
          content: "master_finger: '{{ fingerprint.stdout }}'"
          dest: /etc/salt/minion.d/master_finger.conf
          owner: root
          group: salt
          mode: '0440'
        when: not test_contents.stat.exists
      - name: Creating OpenRC script to mount --make-rshared /
        copy:
          content: "{{ mount_rshared_openrc }}"
          dest: /etc/init.d/mount_rshared
          owner: root
          group: root
          mode: '0550'
      - name: Enabling salt-minion service
        service:
          name: salt-minion
          enabled: true
        when: not test_contents.stat.exists
      - name: Enabling kubelet service
        service:
          name: kubelet
          enabled: true
      - name: Enabling containerd service
        service:
          name: containerd
          enabled: true
      - name: Enabling service to mount --make-rshared /
        service:
          name: mount_rshared
          enabled: true
  - name: Provisioning Alpine 3.14 K8s (control-planes...more)
    hosts: control_planes
    become: true
    tasks:
      - name: Adding cluster packages specific to control-planes
        community.general.apk:
          name:
            - kubectl
            - patch
            - librdkafka
            - yajl
            - coreutils
          state: latest
      - name: Checking whether to copy kcat
        ansible.builtin.stat:
          path: /vagrant/kcat
        register: test_kcat
      - name: Copying kcat
        copy:
          src: /vagrant/kcat
          dest: /usr/local/bin/kcat
          owner: root
          group: root
          mode: '0555'
          remote_src: true
        when: test_kcat.stat.exists
      - name: Checking whether to copy stern
        ansible.builtin.stat:
          path: /vagrant/stern
        register: test_stern
      - name: Copying stern
        copy:
          src: /vagrant/stern
          dest: /usr/local/bin/stern
          owner: root
          group: root
          mode: '0555'
          remote_src: true
          checksum: a776b5c4d8fa9d253e1f911d86eb1ca78934ff16
        when: test_stern.stat.exists
